document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.tab-button');
    const calculateButton = document.getElementById('calculate-button');
    const jumlahPinjamanInput = document.getElementById('jumlah-pinjaman');
    const tenorBulanInput = document.getElementById('tenor-bulan');
    const resultsDisplay = document.getElementById('results-display');
    const articlesFeed = document.getElementById('articles-feed'); 

    // Create archive button dynamically (since it's not in HTML)
    const loadArchiveBtn = document.createElement('button');
    loadArchiveBtn.textContent = 'Lihat Arsip Artikel';
    loadArchiveBtn.classList.add('load-archive-btn');
    loadArchiveBtn.id = 'load-archive-btn';
    articlesFeed.insertAdjacentElement('afterend', loadArchiveBtn); 

    let activeLoanType = 'pinjol';
    let allLenderData = {}; 

    const BACKEND_URL = 'https://sandy-adaptable-pomelo.glitch.me'; 

    // Tab functionality
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all buttons
            tabButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');
            // Update active loan type
            activeLoanType = button.dataset.tab;
            // Clear previous results
            resultsDisplay.innerHTML = '<p>Masukkan data di atas untuk melihat perbandingan pinjaman.</p>';
            console.log('Active loan type:', activeLoanType);
        });
    });

    // Function to fetch lender data
    async function fetchAllLenderData() {
        try {
            const response = await fetch(`${BACKEND_URL}/api/lenders`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            allLenderData = data;
            return data;
        } catch (error) {
            console.error('Error fetching lender data:', error);
            return {};
        }
    }

    // Helper function to render a single article card
    function renderArticleCard(article, targetElement) {
        const articleCard = document.createElement('div');
        articleCard.classList.add('article-card');

        // Replace newlines with <br> tags for proper paragraph breaks in HTML
        const formattedContentWithBr = article.content.replace(/\n/g, '<br>'); 
        
        // Check if marked.js is available, otherwise use plain text
        let finalHtmlContent;
        if (typeof marked !== 'undefined' && marked.parse) {
            finalHtmlContent = marked.parse(formattedContentWithBr);
        } else {
            finalHtmlContent = formattedContentWithBr;
            console.warn('marked.js not loaded, using plain HTML');
        }

        let displaySnippet = '';
        let showReadMore = false;

        // Check if there's more content than the snippet
        if (article.content.length > 200) {
            if (typeof marked !== 'undefined' && marked.parse) {
                displaySnippet = marked.parse(article.content.substring(0, 200)).replace(/\n/g, '<br>');
            } else {
                displaySnippet = article.content.substring(0, 200).replace(/\n/g, '<br>');
            }
            showReadMore = true;
        } else {
            displaySnippet = finalHtmlContent;
            showReadMore = false;
        }

        // Add Date and Categories (Tags)
        const tagsHtml = article.tags ? article.tags.map(tag => `<span class="article-tag">${tag}</span>`).join(' ') : '';
        const formattedDate = new Date(article.date).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });

        articleCard.innerHTML = `
            <h3>${article.title}</h3>
            <p class="article-meta">
                <span class="article-date">${formattedDate}</span>
                <span class="article-categories">${tagsHtml}</span>
            </p>
            <div class="article-content-wrapper">
                <span class="article-snippet">${displaySnippet}</span>
                ${showReadMore ? `<span class="article-ellipsis" style="display:inline;">...</span><span class="article-full" style="display: none;">${finalHtmlContent}</span>` : ''}
            </div>
            ${showReadMore ? '<a href="#" class="read-more-btn">Baca Selengkapnya</a>' : ''}
        `;
        targetElement.appendChild(articleCard); 

        // Add event listener only if the button exists
        if (showReadMore) {
            const readMoreBtn = articleCard.querySelector('.read-more-btn');
            if (readMoreBtn) {
                readMoreBtn.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    const contentWrapper = readMoreBtn.previousElementSibling; 
                    const snippetSpan = contentWrapper.querySelector('.article-snippet');
                    const ellipsisSpan = contentWrapper.querySelector('.article-ellipsis');
                    const fullSpan = contentWrapper.querySelector('.article-full');

                    // Add safety checks to prevent null errors
                    if (!snippetSpan || !ellipsisSpan || !fullSpan) {
                        console.error('Could not find required elements for read more functionality');
                        return;
                    }

                    if (fullSpan.style.display === 'none' || fullSpan.style.display === '') {
                        snippetSpan.style.display = 'none';
                        ellipsisSpan.style.display = 'none';
                        fullSpan.style.display = 'block'; 
                        readMoreBtn.textContent = 'Sembunyikan'; 
                    } else {
                        snippetSpan.style.display = 'inline'; 
                        ellipsisSpan.style.display = 'inline';
                        fullSpan.style.display = 'none';
                        readMoreBtn.textContent = 'Baca Selengkapnya'; 
                    }
                });
            }
        }
    }

    // Function to fetch articles
    async function fetchArticles() {
        try {
            const response = await fetch(`${BACKEND_URL}/api/articles?count=3`); 
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const responseData = await response.json(); 
            const articles = responseData.data;

            if (!articles || articles.length === 0) {
                 articlesFeed.innerHTML = '<p>Gagal memuat artikel. Tidak ada data.</p>';
                 return;
            }

            articlesFeed.innerHTML = '';
            articles.forEach(article => {
                renderArticleCard(article, articlesFeed);
            });

        } catch (error) {
            console.error('Error fetching articles:', error);
            articlesFeed.innerHTML = '<p>Gagal memuat artikel dari backend. (Pastikan backend berjalan dan URL benar).</p>';
        }
    }

    // Function to fetch archived articles
    async function fetchArchivedArticles() {
        try {
            if (loadArchiveBtn) {
                loadArchiveBtn.disabled = true; 
                loadArchiveBtn.textContent = 'Memuat Arsip...';
            }

            const response = await fetch(`${BACKEND_URL}/api/articles/archive`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const responseData = await response.json();
            const archivedArticles = responseData.data;

            let archiveContainer = document.getElementById('archive-articles-feed');
            if (!archiveContainer) {
                archiveContainer = document.createElement('div');
                archiveContainer.id = 'archive-articles-feed';
                archiveContainer.style.marginTop = '30px';
                archiveContainer.style.borderTop = '1px solid var(--light-purple)';
                archiveContainer.style.paddingTop = '20px';
                articlesFeed.parentNode.appendChild(archiveContainer);
            }
            
            archiveContainer.innerHTML = '<h3>Arsip Artikel</h3>';

            if (!archivedArticles || archivedArticles.length === 0) {
                archiveContainer.innerHTML += '<p>Tidak ada artikel dalam arsip.</p>';
            } else {
                archivedArticles.sort((a, b) => new Date(b.date) - new Date(a.date));
                archivedArticles.forEach(article => {
                    renderArticleCard(article, archiveContainer);
                });
            }
            
            if (loadArchiveBtn) {
                loadArchiveBtn.style.display = 'none'; 
            }

        } catch (error) {
            console.error('Error fetching archived articles:', error);
            const archiveContainer = document.getElementById('archive-articles-feed') || document.createElement('div');
            archiveContainer.id = 'archive-articles-feed';
            archiveContainer.innerHTML = '<p>Gagal memuat arsip artikel.</p>';
        }
    }

    // Function to render loan calculation results
    function renderResults() {
        const jumlahPinjaman = parseFloat(jumlahPinjamanInput.value) || 0;
        const tenorBulan = parseInt(tenorBulanInput.value) || 0;
        
        if (jumlahPinjaman <= 0 || tenorBulan <= 0) {
            resultsDisplay.innerHTML = '<p>Masukkan jumlah pinjaman dan tenor yang valid.</p>';
            return;
        }

        resultsDisplay.innerHTML = '<p>Memuat data pemberi pinjaman...</p>';

        fetchAllLenderData().then(lenderData => {
            // Basic loan calculation logic
            const results = calculateLoanOptions(jumlahPinjaman, tenorBulan, activeLoanType, lenderData);
            displayResults(results);
        }).catch(error => {
            console.error('Error in renderResults:', error);
            resultsDisplay.innerHTML = '<p>Terjadi kesalahan saat memuat data pemberi pinjaman.</p>';
        });
    }

    // Function to calculate loan options
    function calculateLoanOptions(principal, tenure, loanType, lenderData) {
        // This is a simplified calculation - you'll need to implement proper logic based on your backend data
        const results = [];
        
        // Example calculation for different loan types
        let baseRate = 0.12; // 12% annual rate as default
        
        switch(loanType) {
            case 'pinjol':
                baseRate = 0.15; // 15% for pinjol
                break;
            case 'kpr':
                baseRate = 0.08; // 8% for KPR
                break;
            case 'kmg':
                baseRate = 0.10; // 10% for KMG
                break;
        }

        // Calculate monthly payment using simple formula
        const monthlyRate = baseRate / 12;
        const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, tenure)) / (Math.pow(1 + monthlyRate, tenure) - 1);
        const totalPayment = monthlyPayment * tenure;
        const totalInterest = totalPayment - principal;

        results.push({
            lender: `${loanType.toUpperCase()} Calculator`,
            monthlyPayment: monthlyPayment,
            totalPayment: totalPayment,
            totalInterest: totalInterest,
            interestRate: baseRate * 100
        });

        return results;
    }

    // Function to display calculation results
    function displayResults(results) {
        if (results.length === 0) {
            resultsDisplay.innerHTML = '<p>Tidak ada data pemberi pinjaman yang tersedia.</p>';
            return;
        }

        let resultHTML = '<div class="loan-results">';
        
        results.forEach(result => {
            resultHTML += `
                <div class="loan-option">
                    <h4>${result.lender}</h4>
                    <p><strong>Cicilan Bulanan:</strong> Rp ${result.monthlyPayment.toLocaleString('id-ID')}</p>
                    <p><strong>Total Pembayaran:</strong> Rp ${result.totalPayment.toLocaleString('id-ID')}</p>
                    <p><strong>Total Bunga:</strong> Rp ${result.totalInterest.toLocaleString('id-ID')}</p>
                    <p><strong>Suku Bunga:</strong> ${result.interestRate.toFixed(2)}% per tahun</p>
                </div>
            `;
        });
        
        resultHTML += '</div>';
        resultsDisplay.innerHTML = resultHTML;
    }

    // Event listeners
    if (calculateButton) {
        calculateButton.addEventListener('click', renderResults);
    }

    if (loadArchiveBtn) {
        loadArchiveBtn.addEventListener('click', fetchArchivedArticles);
    }

    // Initialize the application
    fetchArticles();
    fetchAllLenderData();
});
